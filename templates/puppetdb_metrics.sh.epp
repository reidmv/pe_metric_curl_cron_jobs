<%- | String        $output_dir,
      Array[String] $hosts,
| -%>
<%
  $metrics_base = [
                    { 'url' => 'org.apache.activemq:type=Broker,brokerName=localhost,destinationType=Queue,destinationName=puppetlabs.puppetdb.commands',
                      'name' => 'activemq' },
                    { 'url' => 'puppetlabs.puppetdb.storage%3Aname%3Dcatalog-hash-miss-time',
                      'name' => 'catalog_hash_miss'},
                    { 'url' => 'puppetlabs.puppetdb.storage%3Aname%3Dcatalog-hash-match-time',
                      'name' => 'catalog_hash_match'},
                    { 'url' => 'puppetlabs.puppetdb.storage%3Aname%3Dreplace-catalog-time',
                      'name' => 'replace_catalog_time'},
                    { 'url' => 'puppetlabs.puppetdb.storage%3Aname%3Dreplace-facts-time',
                      'name' => 'replace_facts_time'},
                    { 'url' => 'puppetlabs.puppetdb.storage%3Aname%3Dstore-report-time',
                      'name' => 'store_report_time'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dglobal.retried',
                      'name' => 'global_retried'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dglobal.retry-counts',
                      'name' => 'global_retry_counts'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dglobal.retry-persistence-time',
                      'name' => 'global_retry_persistence_time'},
                  ]

  $metrics_20164 = [
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dreplace+catalog.9.retried',
                      'name' => 'replace_catalog_retried'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dreplace+catalog.9.retry-counts',
                      'name' => 'replace_catalog_retry_counts'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dreplace+catalog.9.retry-persistence-time',
                      'name' => 'replace_catalog_retry_persistence_time'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dreplace+facts.5.retried',
                      'name' => 'replace_facts_retried'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dreplace+facts.5.retry-counts',
                      'name' => 'replace_facts_retry_counts'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dreplace+facts.5.retry-persistence-time',
                      'name' => 'replace_facts_retry_persistence_time'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dstore+report.8.retried',
                      'name' => 'store_report_retried'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dstore+report.8.retry-counts',
                      'name' => 'store_reports_retry_counts'},
                    { 'url' => 'puppetlabs.puppetdb.mq%3Aname%3Dstore+report.8.retry-persistence-time',
                      'name' => 'store_report_retry_persistence_time'},
                   ]

    $metrics_array = $::pe_server_version ? {
      /^2016.4./ => $metrics_base + $metrics_20164,
      default    => $metrics_base
    }
-%>
<% $hosts.each | $host | {
     $temp_file = "${output_dir}/${host}-temp"
-%>
echo '{ "puppetdb": {' > <%= $temp_file %>
<%
     $metrics_array.each | $metric | {
       $curl_command = "curl -k https://${host}:8081/metrics/v1/mbeans/${metric['url']}"
       $curl_certs   = "--cert /etc/puppetlabs/puppet/ssl/certs/${::clientcert}.pem --key /etc/puppetlabs/puppet/ssl/private_keys/${::clientcert}.pem --cacert /etc/puppetlabs/puppet/ssl/certs/ca.pem"
       $pipe_to_ruby   = "| /opt/puppetlabs/puppet/bin/ruby -e 'require \"json\"; puts(\"${metric['name']}\" => JSON.parse(STDIN.read).to_json)'"
       $append_to_file = ">> ${temp_file}"
-%>

  <%= $curl_command %> <%= $curl_certs %> <%= $pipe_to_ruby %> <%= $append_to_file %>
<% }
-%>
echo '}' >> <%= $temp_file %>
cat <%= $temp_file %> | python -m json.tool >> <%= $output_dir %>/<%= $host %>-`date +'%m_%d_%y_%R'`.json
<%
}
-%>
